<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工单管理 - 服务管理</title>
  <!-- 引入外部资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    /* 继承全局样式 */
    body { font-family: "微软雅黑", "思源黑体", sans-serif; background-color: #f5f7fa; color: #333; }
    .btn-primary { background-color: #1890FF; border-color: #1890FF; }
    .btn-primary:hover { background-color: #096DD9; border-color: #096DD9; }
    .btn-outline-secondary { border-color: #ddd; color: #666; }
    .btn-outline-secondary:hover { background-color: #f5f5f5; border-color: #ccc; }
    .btn-danger { background-color: #FF4D4F; border-color: #FF4D4F; }
    .btn-danger:hover { background-color: #F5222D; border-color: #F5222D; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0; padding: 15px 20px; font-weight: 600; font-size: 15px; }
    .card-body { padding: 20px; }
    /* 布局样式 */
    .app-container { display: flex; min-height: 100vh; }
    /* 侧边导航 */
    .sidebar { width: 220px; background: #fff; box-shadow: 1px 0 2px rgba(0,0,0,0.05); padding: 20px 0; flex-shrink: 0; }
    .sidebar-logo { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
    .sidebar-logo img { height: 40px; margin-bottom: 8px; }
    .sidebar-logo h3 { font-size: 16px; color: #1890FF; font-weight: 600; margin: 0; }
    .nav-menu { list-style: none; padding: 0; margin: 0; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #666; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
    .nav-link:hover, .nav-link.active { color: #1890FF; background-color: #f0f7ff; border-left: 3px solid #1890FF; }
    .nav-link i { font-size: 18px; margin-right: 12px; width: 20px; text-align: center; }
    .nav-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 500; }
    /* 主内容区 */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    /* 顶部导航 */
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0; }
    .user-info { display: flex; align-items: center; }
    .notification { position: relative; margin-right: 20px; cursor: pointer; }
    .notification i { font-size: 20px; color: #666; }
    .notification-badge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #FF4D4F; color: #fff; border-radius: 50%; font-size: 12px; text-align: center; line-height: 18px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1890FF; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; margin-right: 10px; }
    .user-name { font-size: 14px; font-weight: 500; }

    /* 工单管理专属样式 */
    .filter-bar { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
    .filter-group { flex: 1; min-width: 150px; }
    .filter-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
    .filter-group input, .filter-group select { width: 100%; }
    .workorder-table { width: 100%; border-collapse: collapse; }
    .workorder-table th, .workorder-table td { border: 1px solid #f0f0f0; padding: 12px 15px; text-align: left; font-size: 13px; }
    .workorder-table th { background-color: #f8f9fa; font-weight: 500; }
    .workorder-table tbody tr:hover { background-color: #f9f9f9; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .status-pending { background-color: #FFF7E6; color: #FAAD14; }
    .status-progress { background-color: #E6F7FF; color: #1890FF; }
    .status-completed { background-color: #E6F7E6; color: #52C41A; }
    .status-cancelled { background-color: #FFF1F0; color: #FF4D4F; }
    .status-void { background-color: #F5F5F5; color: #999; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 侧边导航 -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <img src="https://via.placeholder.com/80x40?text=居家长护" alt="系统Logo">
        <h3>服务主管工作平台</h3>
      </div>
      
      <!-- 导航分组：看板管理 -->
      <div class="nav-group-title">看板管理</div>
      <ul class="nav-menu">

        <li class="nav-item">
          <a href="index.html" class="nav-link">
            <i class="fa fa-dashboard"></i>
            <span>服务对象看板</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="总体统计.html" class="nav-link">
            <i class="fa fa-bar-chart"></i>
            <span>总体统计看板</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="流程管理.html" class="nav-link">
            <i class="fa fa-sitemap"></i>
            <span>流程管理</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="线上回访.html" class="nav-link">
            <i class="fa fa-phone"></i>
            <span>线上线下回访执行</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="服务对象分配.html" class="nav-link">
            <i class="fa fa-users"></i>
            <span>服务对象分配</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="新增服务对象管理.html" class="nav-link">
            <i class="fa fa-user-plus"></i>
            <span>新增服务对象配置</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="首月服务计划管理.html" class="nav-link">
            <i class="fa fa-calendar"></i>
            <span>服务计划管理或打印</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="平台工单差异查询.html" class="nav-link">
            <i class="fa fa-search"></i>
            <span>医保工单差异查询</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="工单管理.html" class="nav-link active">
            <i class="fa fa-tasks"></i>
            <span>工单管理</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="重点服务对象管理.html" class="nav-link">
            <i class="fa fa-star"></i>
            <span>重点服务对象管理</span>
          </a>
        </li>
      </ul>
      
      <!-- 导航分组：系统设置 -->
      <div class="nav-group-title">系统设置</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link" id="caregiverSettingsLink">
            <i class="fa fa-cog"></i>
            <span>护理员设置</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 顶部导航：标题 + 用户信息 -->
      <div class="top-nav">
        <h1 class="page-title">工单管理</h1>
        <div class="user-info">
          <div class="notification">
            <i class="fa fa-bell-o"></i>
            <span class="notification-badge">2</span>
          </div>
          <div class="user-avatar">主</div>
          <div class="user-name">服务主管</div>
        </div>
      </div>

      <!-- 筛选栏 -->
      <div class="filter-bar">
        <div class="filter-group">
          <label for="filterDate">服务日期</label>
          <input type="date" class="form-control" id="filterDate" value="2025-10-15">
        </div>
        <div class="filter-group">
          <label for="filterCaregiver">护理员</label>
          <select class="form-select" id="filterCaregiver">
            <option value="">全部护理员</option>
            <option value="李护理">李护理</option>
            <option value="王护理">王护理</option>
            <option value="张护理">张护理</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterStatus">工单状态</label>
          <select class="form-select" id="filterStatus">
            <option value="">全部状态</option>
            <option value="pending">待执行</option>
            <option value="progress">执行中</option>
            <option value="completed">已完成</option>
            <option value="cancelled">已取消</option>
            <option value="void">已作废</option>
          </select>
        </div>
        <div class="filter-group" style="align-self: flex-end;">
          <button class="btn btn-primary" id="queryBtn">
            <i class="fa fa-search"></i> 查询
          </button>
          <button class="btn btn-outline-secondary" id="resetBtn">
            <i class="fa fa-refresh"></i> 重置
          </button>
        </div>
      </div>

      <!-- 工单列表 -->
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span>工单列表</span>
            <span class="text-muted" style="font-size: 13px; font-weight: normal;">
              共 <span id="totalCount">0</span> 条工单
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="workorder-table" id="workorderTable">
              <thead>
                <tr>
                  <th style="width: 60px;">序号</th>
                  <th style="width: 100px;">服务对象</th>
                  <th style="width: 120px;">服务日期</th>
                  <th style="width: 100px;">服务时间</th>
                  <th style="width: 100px;">护理员</th>
                  <th style="width: 120px;">服务套餐</th>
                  <th style="width: 100px;">工单状态</th>
                  <th style="width: 150px;">签入时间</th>
                  <th style="width: 150px;">签出时间</th>
                  <th style="width: 200px;">操作</th>
                </tr>
              </thead>
              <tbody id="workorderTableBody">
                <!-- 数据将通过JS动态生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 取消签入确认模态框 -->
  <div class="modal fade" id="cancelCheckinModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">取消签入确认</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>确定要取消该工单的签入吗？取消后工单将恢复为"待执行"状态。</p>
          <div class="mb-3">
            <label class="form-label">取消原因</label>
            <textarea class="form-control" id="cancelCheckinReason" rows="3" placeholder="请填写取消签入的原因"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmCancelCheckinBtn">确认取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 作废工单确认模态框 -->
  <div class="modal fade" id="voidWorkorderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">作废工单确认</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-danger"><strong>警告：</strong>作废后的工单将无法恢复，请谨慎操作！</p>
          <div class="mb-3">
            <label class="form-label">作废原因 <span class="text-danger">*</span></label>
            <textarea class="form-control" id="voidWorkorderReason" rows="3" placeholder="请详细填写作废原因" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmVoidWorkorderBtn">确认作废</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(function() {
      // 统一的提示函数
      function showMessage(title, message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        const alertHtml = `
          <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <strong>${title}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        $('body').append(alertHtml);
        setTimeout(() => {
          $('.alert').fadeOut(() => $(this).remove());
        }, 3000);
      }
      
      // 初始化模态框
      const cancelCheckinModal = new bootstrap.Modal('#cancelCheckinModal');
      const voidWorkorderModal = new bootstrap.Modal('#voidWorkorderModal');
      
      let currentWorkorderId = null;
      
      // 模拟工单数据
      const mockWorkorderData = [
        {
          id: 1,
          clientId: 1,
          clientName: '陈一',
          serviceDate: '2025-10-15',
          serviceTime: '09:00-11:00',
          caregiver: '李护理',
          packageName: '基础护理套餐',
          status: 'progress',
          checkinTime: '2025-10-15 09:05',
          checkoutTime: ''
        },
        {
          id: 2,
          clientId: 2,
          clientName: '吴二',
          serviceDate: '2025-10-15',
          serviceTime: '14:00-16:00',
          caregiver: '王护理',
          packageName: '生活照料套餐',
          status: 'pending',
          checkinTime: '',
          checkoutTime: ''
        },
        {
          id: 3,
          clientId: 3,
          clientName: '郑三',
          serviceDate: '2025-10-15',
          serviceTime: '10:00-12:00',
          caregiver: '张护理',
          packageName: '康复训练套餐',
          status: 'completed',
          checkinTime: '2025-10-15 10:02',
          checkoutTime: '2025-10-15 11:58'
        },
        {
          id: 4,
          clientId: 4,
          clientName: '冯四',
          serviceDate: '2025-10-15',
          serviceTime: '15:00-17:00',
          caregiver: '李护理',
          packageName: '基础护理套餐',
          status: 'cancelled',
          checkinTime: '',
          checkoutTime: ''
        }
      ];
      
      // 渲染工单列表
      function renderWorkorderList() {
        const tbody = $('#workorderTableBody');
        tbody.empty();
        
        let filteredData = mockWorkorderData;
        
        // 按日期筛选
        const filterDate = $('#filterDate').val();
        if (filterDate) {
          filteredData = filteredData.filter(item => item.serviceDate === filterDate);
        }
        
        // 按护理员筛选
        const filterCaregiver = $('#filterCaregiver').val();
        if (filterCaregiver) {
          filteredData = filteredData.filter(item => item.caregiver === filterCaregiver);
        }
        
        // 按状态筛选
        const filterStatus = $('#filterStatus').val();
        if (filterStatus) {
          filteredData = filteredData.filter(item => item.status === filterStatus);
        }
        
        if (filteredData.length === 0) {
          tbody.html('<tr><td colspan="10" class="text-center text-muted">暂无工单记录</td></tr>');
          $('#totalCount').text(0);
          return;
        }
        
        filteredData.forEach((item, index) => {
          const statusClass = item.status === 'pending' ? 'status-pending' :
                            item.status === 'progress' ? 'status-progress' :
                            item.status === 'completed' ? 'status-completed' :
                            item.status === 'cancelled' ? 'status-cancelled' :
                            'status-void';
          
          const statusText = item.status === 'pending' ? '待执行' :
                            item.status === 'progress' ? '执行中' :
                            item.status === 'completed' ? '已完成' :
                            item.status === 'cancelled' ? '已取消' :
                            '已作废';
          
          let actionButtons = '';
          if (item.status === 'progress') {
            actionButtons = `
              <button class="btn btn-sm btn-danger cancel-checkin-btn" data-id="${item.id}">取消签入</button>
            `;
          } else if (item.status === 'pending' || item.status === 'completed') {
            actionButtons = `
              <button class="btn btn-sm btn-outline-danger void-workorder-btn" data-id="${item.id}">作废</button>
            `;
          }
          
          const detailLink = item.clientId ? `<a href="javascript:void(0)" class="obj-detail-link" data-id="${item.clientId}" title="查看详情" style="color: #1890FF; margin-left: 8px;"><i class="fa fa-info-circle"></i></a>` : '';
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>
                ${item.clientName}
                ${detailLink}
              </td>
              <td>${item.serviceDate}</td>
              <td>${item.serviceTime}</td>
              <td>${item.caregiver}</td>
              <td>${item.packageName}</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>${item.checkinTime || '-'}</td>
              <td>${item.checkoutTime || '-'}</td>
              <td>${actionButtons}</td>
            </tr>
          `;
          tbody.append(row);
        });
        
        $('#totalCount').text(filteredData.length);
        
        // 重新绑定按钮事件
        $('.cancel-checkin-btn').off('click').on('click', function() {
          const id = parseInt($(this).data('id'));
          currentWorkorderId = id;
          $('#cancelCheckinReason').val('');
          cancelCheckinModal.show();
        });
        
        $('.void-workorder-btn').off('click').on('click', function() {
          const id = parseInt($(this).data('id'));
          currentWorkorderId = id;
          $('#voidWorkorderReason').val('');
          voidWorkorderModal.show();
        });
      }
      
      // 确认取消签入
      $('#confirmCancelCheckinBtn').click(function() {
        const reason = $('#cancelCheckinReason').val();
        if (!reason) {
          alert('请填写取消签入的原因');
          return;
        }
        
        // 更新工单状态（实际项目中应调用后端API）
        const workorder = mockWorkorderData.find(w => w.id === currentWorkorderId);
        if (workorder) {
          workorder.status = 'pending';
          workorder.checkinTime = '';
        }
        
        showMessage('成功', '已取消签入', 'success');
        cancelCheckinModal.hide();
        renderWorkorderList();
      });
      
      // 确认作废工单
      $('#confirmVoidWorkorderBtn').click(function() {
        const reason = $('#voidWorkorderReason').val();
        if (!reason) {
          alert('请填写作废原因');
          return;
        }
        
        if (!confirm('确定要作废该工单吗？作废后将无法恢复！')) {
          return;
        }
        
        // 更新工单状态（实际项目中应调用后端API）
        const workorder = mockWorkorderData.find(w => w.id === currentWorkorderId);
        if (workorder) {
          workorder.status = 'void';
        }
        
        showMessage('成功', '工单已作废', 'success');
        voidWorkorderModal.hide();
        renderWorkorderList();
      });
      
      // 查询按钮
      $('#queryBtn').click(function() {
        renderWorkorderList();
      });
      
      // 重置按钮
      $('#resetBtn').click(function() {
        $('#filterDate').val('');
        $('#filterCaregiver').val('');
        $('#filterStatus').val('');
        renderWorkorderList();
      });
      
      // 服务对象详情功能
      const objectDetailModal = new bootstrap.Modal('#objectDetailModal');
      const mockClientDetailData = {
        1: { id: 1, name: '陈一', gender: '男', level: '一级', address: '越城区九十村58号', phone: '13800138001', status: '正常', caregiver: '李护理', remainHours: 1, workOrders: '每周一、三、五，每次2小时' },
        2: { id: 2, name: '吴二', gender: '女', level: '二级', address: '柯桥区四五村18号', phone: '13800138002', status: '正常', caregiver: '王护理', remainHours: 3, workOrders: '每周二、四、六，每次2.5小时' },
        3: { id: 3, name: '郑三', gender: '男', level: '三级', address: '上虞区三六村25号', phone: '13800138003', status: '暂停', caregiver: '张护理', remainHours: 30, workOrders: '已暂停' },
        4: { id: 4, name: '冯四', gender: '女', level: '一级', address: '诸暨市一二村88号', phone: '13800138004', status: '正常', caregiver: '李护理', remainHours: 60, workOrders: '每周一、三、五，每次2小时' }
      };
      
      function showObjectDetail(objId) {
        const obj = mockClientDetailData[objId];
        if (!obj) {
          alert('未找到服务对象数据');
          return;
        }
        
        const basicInfoHtml = `
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">姓名</label>
                <div class="form-control-plaintext">${obj.name}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">性别</label>
                <div class="form-control-plaintext">${obj.gender}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">失能等级</label>
                <div class="form-control-plaintext">${obj.level}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">居住地址</label>
                <div class="form-control-plaintext">${obj.address}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">联系电话</label>
                <div class="form-control-plaintext">${obj.phone || '-'}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">服务状态</label>
                <div class="form-control-plaintext">${obj.status}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">负责护理员</label>
                <div class="form-control-plaintext">${obj.caregiver}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">剩余工时</label>
                <div class="form-control-plaintext">${obj.remainHours}小时</div>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">工单安排</label>
                <div class="form-control-plaintext">${obj.workOrders || '-'}</div>
              </div>
            </div>
          </div>
        `;
        
        $('#objectDetailModalTitle').text(`服务对象详情 - ${obj.name}`);
        $('#objectDetailBody').html(basicInfoHtml);
        objectDetailModal.show();
      }
      
      $(document).on('click', '.obj-detail-link', function(e) {
        e.stopPropagation();
        const objId = parseInt($(this).data('id'));
        showObjectDetail(objId);
      });
      
      // 初始化渲染
      renderWorkorderList();
    });
  </script>
  
  <!-- 服务对象详情模态框 -->
  <div class="modal fade" id="objectDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="objectDetailModalTitle">服务对象详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="objectDetailBody" class="mt-3">
            <!-- 基本信息内容将通过JavaScript动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

