<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>回访管理 - 服务管理</title>
  <!-- 引入外部资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <style>
    /* 继承全局样式 */
    body { font-family: "微软雅黑", "思源黑体", sans-serif; background-color: #f5f7fa; color: #333; }
    .btn-primary { background-color: #1890FF; border-color: #1890FF; }
    .btn-primary:hover { background-color: #096DD9; border-color: #096DD9; }
    .btn-outline-secondary { border-color: #ddd; color: #666; }
    .btn-outline-secondary:hover { background-color: #f5f5f5; border-color: #ccc; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0; padding: 15px 20px; font-weight: 600; font-size: 15px; }
    .card-body { padding: 20px; }
    /* 布局样式 */
    .app-container { display: flex; min-height: 100vh; }
    /* 侧边导航 */
    .sidebar { width: 220px; background: #fff; box-shadow: 1px 0 2px rgba(0,0,0,0.05); padding: 20px 0; flex-shrink: 0; }
    .sidebar-logo { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
    .sidebar-logo img { height: 40px; margin-bottom: 8px; }
    .sidebar-logo h3 { font-size: 16px; color: #1890FF; font-weight: 600; margin: 0; }
    .nav-menu { list-style: none; padding: 0; margin: 0; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #666; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
    .nav-link:hover, .nav-link.active { color: #1890FF; background-color: #f0f7ff; border-left: 3px solid #1890FF; }
    .nav-link i { font-size: 18px; margin-right: 12px; width: 20px; text-align: center; }
    .nav-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 500; }
    /* 主内容区 */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    /* 顶部导航 */
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0; }
    .user-info { display: flex; align-items: center; }
    .notification { position: relative; margin-right: 20px; cursor: pointer; }
    .notification i { font-size: 20px; color: #666; }
    .notification-badge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #FF4D4F; color: #fff; border-radius: 50%; font-size: 12px; text-align: center; line-height: 18px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1890FF; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; margin-right: 10px; }
    .user-name { font-size: 14px; font-weight: 500; }

    /* 回访管理页面专属样式 */
    .visit-tabs .nav-link { padding: 10px 20px; }
    
    /* 线上回访样式 */
    .online-visit-container { display: flex; gap: 20px; }
    .visit-list-card { flex: 1; min-width: 300px; }
    .visit-form-card { flex: 1; min-width: 300px; border-top: 3px solid #1890FF; }
    .visit-table { width: 100%; border-collapse: collapse; }
    .visit-table th, .visit-table td { border: 1px solid #f0f0f0; padding: 12px 15px; text-align: left; font-size: 13px; }
    .visit-table th { background-color: #f8f9fa; font-weight: 500; }
    .visit-table tbody tr:hover { background-color: #f9f9f9; }
    .form-label { font-weight: 500; }
    
    /* 线下分配样式 */
    .filter-bar { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
    .filter-group { flex: 1; min-width: 150px; }
    .filter-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
    .action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .assignment-form { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; width: 100%; }
    .assignment-form .form-group { flex: 1; min-width: 150px; }
    
    /* 回访结果样式 */
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    .export-btn { white-space: nowrap; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .status-very-satisfied { background-color: #e6f7ef; color: #52C41A; }
    .status-satisfied { background-color: #f0f9f0; color: #73D13D; }
    .status-average { background-color: #fffbe6; color: #FAAD14; }
    .status-dissatisfied { background-color: #fff1f0; color: #FF4D4F; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 侧边导航 -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <img src="https://via.placeholder.com/80x40?text=居家长护" alt="系统Logo">
        <h3>服务主管工作平台</h3>
      </div>
      
      <!-- 导航分组：统计分析 -->
      <div class="nav-group-title">看板管理</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="数据驾驶舱.html" class="nav-link">
            <i class="fa fa-dashboard"></i>
            <span>数据驾驶舱</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="index.html" class="nav-link">
            <i class="fa fa-dashboard"></i>
            <span>服务对象看板</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="总体统计.html" class="nav-link">
            <i class="fa fa-bar-chart"></i>
            <span>总体统计看板</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="流程管理.html" class="nav-link">
            <i class="fa fa-sitemap"></i>
            <span>流程管理</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="线上回访.html" class="nav-link active">
            <i class="fa fa-phone"></i>
            <span>线上线下回访执行</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="服务对象分配.html" class="nav-link">
            <i class="fa fa-users"></i>
            <span>服务对象分配</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="新增服务对象管理.html" class="nav-link">
            <i class="fa fa-user-plus"></i>
            <span>新增服务对象配置</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="首月服务计划管理.html" class="nav-link">
            <i class="fa fa-calendar"></i>
            <span>服务计划管理或打印</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="平台工单差异查询.html" class="nav-link">
            <i class="fa fa-search"></i>
            <span>医保工单差异查询</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="工单管理.html" class="nav-link">
            <i class="fa fa-tasks"></i>
            <span>工单管理</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="重点服务对象管理.html" class="nav-link">
            <i class="fa fa-star"></i>
            <span>重点服务对象管理</span>
          </a>
        </li>
      </ul>
      
      <!-- 导航分组：系统设置 -->
      <div class="nav-group-title">系统设置</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link" id="caregiverSettingsLink">
            <i class="fa fa-cog"></i>
            <span>护理员设置</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 顶部导航：标题 + 用户信息 -->
      <div class="top-nav">
        <h1 class="page-title">回访管理 - 服务管理</h1>
        <div class="user-info">
          <div class="notification">
            <i class="fa fa-bell-o"></i>
            <span class="notification-badge">2</span>
          </div>
          <div class="user-avatar">主</div>
          <div class="user-name">服务主管</div>
        </div>
      </div>

      <!-- 回访管理标签页 -->
      <ul class="nav nav-tabs visit-tabs" id="visitTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pending-visit-tab" data-bs-toggle="tab" data-bs-target="#pending-visit" type="button" role="tab" aria-controls="pending-visit" aria-selected="true">待回访列表</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="visit-assignment-tab" data-bs-toggle="tab" data-bs-target="#visit-assignment" type="button" role="tab" aria-controls="visit-assignment" aria-selected="false">回访分配</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="visit-execution-tab" data-bs-toggle="tab" data-bs-target="#visit-execution" type="button" role="tab" aria-controls="visit-execution" aria-selected="false">回访执行</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="visit-result-tab" data-bs-toggle="tab" data-bs-target="#visit-result" type="button" role="tab" aria-controls="visit-result" aria-selected="false">回访结果</button>
        </li>
      </ul>

      <!-- 回访管理内容区 -->
      <div class="tab-content" id="visitTabContent">
        <!-- 待回访列表（随机选择） -->
        <div class="tab-pane fade show active" id="pending-visit" role="tabpanel" aria-labelledby="pending-visit-tab">
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <span>待回访服务对象列表（可随机选择）</span>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary btn-sm" id="randomSelectBtn">
                    <i class="fa fa-random"></i> 随机选择
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" id="pendingFilterBtn">
                    <i class="fa fa-filter"></i> 筛选
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- 筛选表单区域 -->
              <div class="filter-panel mb-3" id="pendingFilterPanel" style="display: none;">
                <div class="card border-primary">
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-3">
                        <label for="filterClientName" class="form-label">姓名</label>
                        <input type="text" class="form-control form-control-sm" id="filterClientName" placeholder="请输入姓名">
                      </div>
                      <div class="col-md-3">
                        <label for="filterCaregiver" class="form-label">负责护理员</label>
                        <select class="form-select form-select-sm" id="filterCaregiver">
                          <option value="">全部</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label for="filterVisitInterval" class="form-label">未回访时间间隔</label>
                        <div class="d-flex gap-2">
                          <select class="form-select form-select-sm" id="filterVisitInterval" style="flex: 1;">
                            <option value="">全部</option>
                            <option value="30">30天以上</option>
                            <option value="60">60天以上</option>
                            <option value="90">90天以上</option>
                            <option value="180">180天以上</option>
                            <option value="custom">自定义天数</option>
                          </select>
                          <div id="customDaysGroup" style="display: none; flex: 1;">
                            <input type="number" class="form-control form-control-sm" id="filterCustomDays" placeholder="请输入天数" min="1">
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row mt-3">
                      <div class="col-12">
                        <button type="button" class="btn btn-primary btn-sm" id="applyPendingFilter">
                          <i class="fa fa-search"></i> 应用筛选
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="resetPendingFilter">
                          <i class="fa fa-refresh"></i> 重置
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="visit-table" id="pendingVisitTable">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="selectAllPending"></th>
                      <th>姓名</th>
                      <th>身份证号</th>
                      <th>地址</th>
                      <th>负责护理员</th>
                      <th>上次回访时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="pendingVisitTableBody">
                    <!-- 列表将通过JS动态生成 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 回访分配（POST /returnvisitRecodes） -->
        <div class="tab-pane fade" id="visit-assignment" role="tabpanel" aria-labelledby="visit-assignment-tab">
          <div class="card">
            <div class="card-header">
              <span>回访任务分配</span>
            </div>
            <div class="card-body">
              <!-- 已选择的服务对象列表 -->
              <div class="mb-3">
                <label class="form-label">已选择的服务对象（从待回访列表中选择）</label>
                <div id="selectedClientsList" class="border rounded p-3 bg-light" style="min-height: 50px;">
                  <p class="text-muted mb-0">请从"待回访列表"中选择服务对象后，在此进行分配</p>
                </div>
              </div>

              <!-- 分配表单 -->
              <form id="visitAssignmentForm">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="assignmentVisitType" class="form-label">回访类型 <span class="text-danger">*</span></label>
                    <select class="form-select" id="assignmentVisitType" name="visit_type" required>
                      <option value="">请选择回访类型</option>
                      <option value="1">线上回访</option>
                      <option value="2">线下回访</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="assignmentOpId" class="form-label">分配执行回访的用户 <span class="text-danger">*</span></label>
                    <select class="form-select" id="assignmentOpId" name="op_id" required>
                      <option value="">请选择执行人</option>
                      <option value="1">服务主管</option>
                      <option value="2">张评估员</option>
                      <option value="3">王评估员</option>
                      <option value="4">李护理</option>
                      <option value="5">王护理</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="fa fa-paper-plane"></i> 分配回访任务
                    </button>
                  </div>
                </div>
                <div class="alert alert-info">
                  <i class="fa fa-info-circle"></i> 
                  <strong>API说明：</strong> POST /returnvisitRecodes<br>
                  参数：client_id（服务对象标识）、visit_type（回访类型）、op_id（分配执行回访的用户标识）<br>
                  返回：{id: 新记录的id}
                </div>
              </form>

              <!-- 已分配的回访任务列表 -->
              <div class="mt-4">
                <h6>已分配的回访任务</h6>
                <div class="table-responsive">
                  <table class="visit-table" id="assignedVisitTable">
                    <thead>
                      <tr>
                        <th>服务对象</th>
                        <th>回访类型</th>
                        <th>执行人</th>
                        <th>分配时间</th>
                        <th>状态</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="assignedVisitTableBody">
                      <!-- 列表将通过JS动态生成 -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 回访执行（POST /returnvisitRecodes/:id） -->
        <div class="tab-pane fade" id="visit-execution" role="tabpanel" aria-labelledby="visit-execution-tab">
          <div class="card">
            <div class="card-header">
              <span>回访任务执行</span>
            </div>
            <div class="card-body">
              <!-- 待执行的回访任务列表 -->
              <div class="mb-3">
                <label class="form-label">待执行的回访任务</label>
                <div class="table-responsive">
                  <table class="visit-table" id="pendingExecutionTable">
                    <thead>
                      <tr>
                        <th>服务对象</th>
                        <th>回访类型</th>
                        <th>执行人</th>
                        <th>分配时间</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="pendingExecutionTableBody">
                      <!-- 列表将通过JS动态生成 -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- 回访执行表单 -->
              <div class="card mt-4" id="executionFormCard" style="display: none;">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>执行回访</span>
                    <button type="button" class="btn-close" id="closeExecutionForm" aria-label="Close"></button>
                  </div>
                </div>
                <div class="card-body">
                  <form id="visitExecutionForm">
                    <input type="hidden" id="executionRecordId" name="id">
                    <input type="hidden" id="executionClientId" name="client_id">
                    <input type="hidden" id="executionVisitType" name="visit_type">
                    <input type="hidden" id="executionOpId" name="op_id">
                    
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="executionClientName" class="form-label">服务对象</label>
                        <input type="text" class="form-control" id="executionClientName" readonly>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="executionVisitTypeName" class="form-label">回访类型</label>
                        <input type="text" class="form-control" id="executionVisitTypeName" readonly>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">服务对象满意度 <span class="text-danger">*</span></label>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="satisfaction" id="execVerySatisfied" value="1" required>
                        <label class="form-check-label" for="execVerySatisfied">非常满意</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="satisfaction" id="execSatisfied" value="2">
                        <label class="form-check-label" for="execSatisfied">满意</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="satisfaction" id="execAverage" value="3">
                        <label class="form-check-label" for="execAverage">一般</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="satisfaction" id="execDissatisfied" value="4">
                        <label class="form-check-label" for="execDissatisfied">不满意</label>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="executionClientReq" class="form-label">服务对象要求</label>
                      <textarea class="form-control" id="executionClientReq" name="client_req" rows="3" placeholder="请输入服务对象的要求..." maxlength="254"></textarea>
                    </div>

                    <div class="mb-3">
                      <label for="executionVisitDesc" class="form-label">现场检查具体情况描述</label>
                      <textarea class="form-control" id="executionVisitDesc" name="visit_desc" rows="3" placeholder="请输入现场检查的具体情况描述..." maxlength="254"></textarea>
                    </div>

                    <div class="alert alert-info">
                      <i class="fa fa-info-circle"></i> 
                      <strong>API说明：</strong> POST /returnvisitRecodes/:id<br>
                      参数：satisfaction（服务对象满意度）、visit_desc（现场检查具体情况描述）、client_req（服务对象要求）<br>
                      系统会自动设置 op_time=now()
                    </div>

                    <button type="submit" class="btn btn-primary">
                      <i class="fa fa-check"></i> 提交回访执行结果
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 回访结果查询（GET /returnvisitRecodes） -->
        <div class="tab-pane fade" id="visit-result" role="tabpanel" aria-labelledby="visit-result-tab">
          <div class="card">
            <div class="card-header">
              <div class="result-header">
                <span>回访结果查询</span>
                <div class="d-flex gap-10">
                  <div class="input-group" style="width: auto;">
                    <select class="form-select form-select-sm" id="resultFilterType">
                      <option value="">全部类型</option>
                      <option value="1">线上回访</option>
                      <option value="2">线下回访</option>
                    </select>
                  </div>
                  <div class="input-group" style="width: auto;">
                    <select class="form-select form-select-sm" id="resultFilterOpId">
                      <option value="">全部执行人</option>
                      <option value="1">服务主管</option>
                      <option value="2">张评估员</option>
                      <option value="3">王评估员</option>
                      <option value="4">李护理</option>
                      <option value="5">王护理</option>
                    </select>
                  </div>
                  <div class="input-group" style="width: auto;">
                    <input type="date" class="form-control form-control-sm" id="resultFilterStartTime" placeholder="分配任务时间起点">
                  </div>
                  <div class="input-group" style="width: auto;">
                    <span class="input-group-text">至</span>
                    <input type="date" class="form-control form-control-sm" id="resultFilterStopTime" placeholder="分配任务时间止点">
                  </div>
                  <button class="btn btn-primary btn-sm" id="resultFilterBtn">
                    <i class="fa fa-filter"></i> 查询
                  </button>
                  <button class="btn btn-outline-secondary btn-sm export-btn" id="exportResultBtn">
                    <i class="fa fa-download"></i> 导出报表
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="alert alert-info mb-3">
                <i class="fa fa-info-circle"></i> 
                <strong>API说明：</strong> GET /returnvisitRecodes<br>
                参数：startTime（分配任务时间范围起点）、stopTime（分配任务时间范围止点，起止时间为一组可选选项，需同时选择）、op_id（分配执行回访的用户标识）、visit_type（回访类型）<br>
                返回：MySQL驱动返回查询的结果集对象作为data返回
              </div>
              <div class="table-responsive">
                <table class="visit-table" id="visitResultTable">
                  <thead>
                    <tr>
                      <th>服务对象</th>
                      <th>回访类型</th>
                      <th>满意度</th>
                      <th>执行人</th>
                      <th>分配时间</th>
                      <th>执行时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="visitResultTableBody">
                    <!-- 列表将通过JS动态生成 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 线下回访照片预览模态框 -->
  <div class="modal fade" id="photoPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="photoPreviewTitle">现场照片预览</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="photoCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <div class="carousel-item active">
                <img src="https://via.placeholder.com/800x600?text=现场照片1" class="d-block w-100" alt="现场照片1">
              </div>
              <div class="carousel-item">
                <img src="https://via.placeholder.com/800x600?text=现场照片2" class="d-block w-100" alt="现场照片2">
              </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#photoCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#photoCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== 工具函数 ====================
    // 显示提示信息（仅成功提示）
    function showMessage(title, message, type = 'info') {
      if (type === 'error') return; // 不显示错误提示
      const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
          <strong>${title}</strong> ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      $('body').append(alertHtml);
      setTimeout(() => {
        $('.alert').fadeOut(() => $(this).remove());
      }, 3000);
    }

    // 满意度值映射（与数据库字段对应：int类型 1-4）
    const SATISFACTION_MAP = {
      1: { text: '非常满意', badge: 'status-very-satisfied' },
      2: { text: '满意', badge: 'status-satisfied' },
      3: { text: '一般', badge: 'status-average' },
      4: { text: '不满意', badge: 'status-dissatisfied' }
    };

    // 获取满意度文本
    function getSatisfactionText(value) {
      const satisfactionValue = parseInt(value);
      const entry = SATISFACTION_MAP[satisfactionValue];
      return entry ? entry.text : '';
    }

    // 格式化日期
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toISOString().split('T')[0];
    }

    // 获取当前月份的开始和结束日期
    function getCurrentMonthRange() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const startDate = new Date(year, month, 1);
      const endDate = new Date(year, month + 1, 0);
      return {
        start: formatDate(startDate),
        end: formatDate(endDate)
      };
    }

    $(function() {
      // 初始化模态框
      const photoPreviewModal = new bootstrap.Modal('#photoPreviewModal');
      
      // ==================== 全局数据存储 ====================
      // 待回访服务对象数据
      const mockPendingVisitData = [
        {client_id: 101, client_name: '陈一', client_idcard: '330602********1234', client_address: '杭州市西湖区XX路123号', caregiver_name: '李护理', last_visit_time: '2024-08-15'},
        {client_id: 102, client_name: '吴二', client_idcard: '330602********5678', client_address: '杭州市拱墅区XX路456号', caregiver_name: '王护理', last_visit_time: '2024-08-20'},
        {client_id: 103, client_name: '郑三', client_idcard: '330602********9012', client_address: '杭州市西湖区XX路789号', caregiver_name: '李护理', last_visit_time: '2024-08-18'},
        {client_id: 104, client_name: '冯四', client_idcard: '330602********3456', client_address: '杭州市滨江区XX路321号', caregiver_name: '张护理', last_visit_time: '2024-08-25'},
        {client_id: 105, client_name: '钱五', client_idcard: '330602********7890', client_address: '杭州市上城区XX路654号', caregiver_name: '王护理', last_visit_time: '2024-08-22'},
        {client_id: 106, client_name: '赵六', client_idcard: '330602********2345', client_address: '杭州市下城区XX路987号', caregiver_name: '李护理', last_visit_time: '2024-07-10'},
        {client_id: 107, client_name: '孙七', client_idcard: '330602********6789', client_address: '杭州市江干区XX路111号', caregiver_name: '王护理', last_visit_time: '2024-08-05'}
      ];

      // 已分配的回访任务（模拟数据）
      let assignedVisitTasks = [];
      
      // 已执行的回访记录（模拟数据）
      let executedVisitRecords = [];
      
      // 选中的服务对象（用于分配）
      let selectedClients = [];
      
      // 筛选后的待回访数据
      let filteredPendingVisitData = [...mockPendingVisitData];

      // ==================== 1. 待回访列表（随机选择） ====================
      // 初始化护理员下拉选项
      function initCaregiverFilter() {
        const caregiverSet = new Set();
        mockPendingVisitData.forEach(item => {
          if (item.caregiver_name) {
            caregiverSet.add(item.caregiver_name);
          }
        });
        
        const select = $('#filterCaregiver');
        select.find('option:not(:first)').remove();
        
        Array.from(caregiverSet).sort().forEach(name => {
          select.append(`<option value="${name}">${name}</option>`);
        });
      }
      
      // 计算未回访天数
      function getDaysSinceLastVisit(lastVisitTime) {
        if (!lastVisitTime) return null;
        const lastVisit = new Date(lastVisitTime);
        const now = new Date();
        const diffTime = Math.abs(now - lastVisit);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      }
      
      // 应用筛选条件
      function applyPendingFilter() {
        const clientName = $('#filterClientName').val().trim();
        const caregiver = $('#filterCaregiver').val();
        const visitInterval = $('#filterVisitInterval').val();
        const customDays = parseInt($('#filterCustomDays').val());
        
        filteredPendingVisitData = mockPendingVisitData.filter(item => {
          // 姓名筛选
          if (clientName) {
            if (!item.client_name || !item.client_name.includes(clientName)) {
              return false;
            }
          }
          
          // 负责护理员筛选
          if (caregiver) {
            if (item.caregiver_name !== caregiver) {
              return false;
            }
          }
          
          // 未回访时间间隔筛选
          if (visitInterval) {
            const daysSince = getDaysSinceLastVisit(item.last_visit_time);
            if (daysSince === null) {
              // 如果没有回访记录，可以根据需求决定是否显示
              // 这里假设没有回访记录的也显示
              return true;
            }
            
            if (visitInterval === 'custom') {
              if (isNaN(customDays) || customDays <= 0) {
                return true; // 如果自定义天数无效，不过滤
              }
              return daysSince >= customDays;
            } else {
              const intervalDays = parseInt(visitInterval);
              return daysSince >= intervalDays;
            }
          }
          
          return true;
        });
        
        renderPendingVisitList(filteredPendingVisitData);
        
        // 显示筛选结果提示
        if (clientName || caregiver || visitInterval) {
          showMessage('筛选完成', `找到 ${filteredPendingVisitData.length} 条符合条件的记录`, 'success');
        }
      }
      
      // 重置筛选条件
      function resetPendingFilter() {
        $('#filterClientName').val('');
        $('#filterCaregiver').val('');
        $('#filterVisitInterval').val('');
        $('#filterCustomDays').val('');
        $('#customDaysGroup').hide();
        filteredPendingVisitData = [...mockPendingVisitData];
        renderPendingVisitList(filteredPendingVisitData);
      }
      
      // 加载待回访列表
      function loadPendingVisitList() {
        initCaregiverFilter();
        renderPendingVisitList(filteredPendingVisitData);
      }

      // 渲染待回访列表
      function renderPendingVisitList(data) {
        const tbody = $('#pendingVisitTableBody');
        tbody.empty();
        
        if (!data || data.length === 0) {
          tbody.html('<tr><td colspan="7" class="text-center text-muted">暂无待回访的服务对象</td></tr>');
          return;
        }
        
        data.forEach(item => {
          const isSelected = selectedClients.some(c => c.client_id === item.client_id);
          const detailLink = `<a href="javascript:void(0)" class="obj-detail-link" data-id="${item.client_id}" title="查看详情" style="color: #1890FF; margin-left: 8px;"><i class="fa fa-info-circle"></i></a>`;
          const row = `
            <tr>
              <td>
                <input type="checkbox" class="pending-checkbox" 
                       data-client-id="${item.client_id}"
                       data-client-name="${item.client_name}"
                       ${isSelected ? 'checked' : ''}>
              </td>
              <td>
                ${item.client_name || '未知'}
                ${detailLink}
              </td>
              <td>${item.client_idcard || '-'}</td>
              <td>${item.client_address || '-'}</td>
              <td>${item.caregiver_name || '-'}</td>
              <td>${item.last_visit_time || '-'}</td>
              <td>
                <button class="btn btn-primary btn-sm select-client-btn" 
                        data-client-id="${item.client_id}"
                        data-client-name="${item.client_name}">
                  选择
                </button>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
        
        // 重新绑定事件
        $('.pending-checkbox').off('change').on('change', handlePendingCheckboxChange);
        $('.select-client-btn').off('click').on('click', handleSelectClient);
      }

      // 随机选择功能
      function randomSelectClients(count = 3) {
        const available = filteredPendingVisitData.filter(item => 
          !selectedClients.some(c => c.client_id === item.client_id)
        );
        
        if (available.length === 0) {
          showMessage('提示', '没有可选择的待回访服务对象', 'info');
          return;
        }
        
        const randomCount = Math.min(count, available.length);
        const shuffled = [...available].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, randomCount);
        
        selected.forEach(item => {
          if (!selectedClients.some(c => c.client_id === item.client_id)) {
            selectedClients.push(item);
          }
        });
        
        updateSelectedClientsList();
        renderPendingVisitList(mockPendingVisitData);
        showMessage('成功', `已随机选择 ${selected.length} 个服务对象`, 'success');
      }

      // 处理复选框变化
      function handlePendingCheckboxChange() {
        const clientId = parseInt($(this).data('client-id'));
        const clientName = $(this).data('client-name');
        const isChecked = $(this).prop('checked');
        
        if (isChecked) {
          const client = mockPendingVisitData.find(c => c.client_id === clientId);
          if (client && !selectedClients.some(c => c.client_id === clientId)) {
            selectedClients.push(client);
          }
        } else {
          selectedClients = selectedClients.filter(c => c.client_id !== clientId);
        }
        
        updateSelectedClientsList();
      }

      // 处理选择按钮
      function handleSelectClient() {
        const clientId = parseInt($(this).data('client-id'));
        const client = mockPendingVisitData.find(c => c.client_id === clientId);
        
        if (client && !selectedClients.some(c => c.client_id === clientId)) {
          selectedClients.push(client);
          updateSelectedClientsList();
          renderPendingVisitList(mockPendingVisitData);
          showMessage('成功', `已选择【${client.client_name}】`, 'success');
        }
      }

      // 更新已选择服务对象列表
      function updateSelectedClientsList() {
        const container = $('#selectedClientsList');
        container.empty();
        
        if (selectedClients.length === 0) {
          container.html('<p class="text-muted mb-0">请从"待回访列表"中选择服务对象后，在此进行分配</p>');
          return;
        }
        
        const list = selectedClients.map((client, index) => `
          <span class="badge bg-primary me-2 mb-2" style="font-size: 13px; padding: 6px 12px;">
            ${client.client_name}
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 10px;" 
                    data-client-id="${client.client_id}" aria-label="移除"></button>
          </span>
        `).join('');
        
        container.html(list);
        
        // 绑定移除按钮
        container.find('.btn-close').off('click').on('click', function() {
          const clientId = parseInt($(this).data('client-id'));
          selectedClients = selectedClients.filter(c => c.client_id !== clientId);
          updateSelectedClientsList();
          renderPendingVisitList(mockPendingVisitData);
        });
      }

      // ==================== 2. 回访分配（POST /returnvisitRecodes） ====================
      // 渲染已分配的回访任务列表
      function renderAssignedVisitTasks() {
        const tbody = $('#assignedVisitTableBody');
        tbody.empty();
        
        if (assignedVisitTasks.length === 0) {
          tbody.html('<tr><td colspan="6" class="text-center text-muted">暂无已分配的回访任务</td></tr>');
          return;
        }
        
        assignedVisitTasks.forEach(task => {
          const visitTypeText = task.visit_type === 1 ? '线上回访' : '线下回访';
          const opNameMap = {
            1: '服务主管', 2: '张评估员', 3: '王评估员', 4: '李护理', 5: '王护理'
          };
          const opName = opNameMap[task.op_id] || `用户${task.op_id}`;
          const statusText = task.op_time ? '已执行' : '待执行';
          const statusClass = task.op_time ? 'text-success' : 'text-warning';
          
          const row = `
            <tr>
              <td>${task.client_name || '未知'}</td>
              <td>${visitTypeText}</td>
              <td>${opName}</td>
              <td>${task.alloc_time || '-'}</td>
              <td><span class="${statusClass}">${statusText}</span></td>
              <td>
                ${!task.op_time ? `
                  <button class="btn btn-sm btn-outline-primary edit-assignment-btn" 
                          data-id="${task.id}"
                          data-client-id="${task.client_id}"
                          data-client-name="${task.client_name}">修改</button>
                ` : '-'}
              </td>
            </tr>
          `;
          tbody.append(row);
        });
        
        // 绑定修改按钮事件
        $('.edit-assignment-btn').off('click').on('click', function() {
          const taskId = parseInt($(this).data('id'));
          const clientId = parseInt($(this).data('client-id'));
          const clientName = $(this).data('client-name');
          openEditAssignmentModal(taskId, clientId, clientName);
        });
      }

      // 打开修改回访分配模态框
      function openEditAssignmentModal(taskId, clientId, clientName) {
        const task = assignedVisitTasks.find(t => t.id === taskId);
        if (!task) {
          showMessage('错误', '未找到该回访任务', 'error');
          return;
        }
        
        // 填充表单数据
        $('#editAssignmentRecordId').val(taskId);
        $('#editAssignmentClientId').val(task.client_id);
        $('#editAssignmentClientName').val(task.client_name || clientName || '未知');
        $('#editAssignmentVisitType').val(task.visit_type);
        $('#editAssignmentOpId').val(task.op_id);
        
        // 显示模态框
        const editModal = new bootstrap.Modal('#editAssignmentModal');
        editModal.show();
      }

      // 提交修改回访分配表单
      $('#editAssignmentForm').submit(function(e) {
        e.preventDefault();
        
        const recordId = parseInt($('#editAssignmentRecordId').val());
        const clientId = parseInt($('#editAssignmentClientId').val());
        const visitType = parseInt($('#editAssignmentVisitType').val());
        const opId = parseInt($('#editAssignmentOpId').val());
        const clientName = $('#editAssignmentClientName').val();
        
        if (!visitType || !opId) {
          showMessage('错误', '请填写完整的分配信息', 'error');
          return;
        }
        
        // 查找任务
        const task = assignedVisitTasks.find(t => t.id === recordId);
        if (!task) {
          showMessage('错误', '未找到该回访任务', 'error');
          return;
        }
        
        // 模拟API调用：PUT /returnvisitRecodes/:id
        task.client_id = clientId;
        task.visit_type = visitType;
        task.op_id = opId;
        
        // 更新执行人名称显示
        const opNameMap = {
          1: '服务主管', 2: '张评估员', 3: '王评估员', 4: '李护理', 5: '王护理'
        };
        task.op_name = opNameMap[opId] || `用户${opId}`;
        
        console.log('修改回访分配API调用：PUT /returnvisitRecodes/' + recordId, {
          client_id: clientId,
          visit_type: visitType,
          op_id: opId
        });
        
        showMessage('成功', `已成功修改【${clientName}】的回访分配！`, 'success');
        
        // 关闭模态框
        const editModal = bootstrap.Modal.getInstance('#editAssignmentModal');
        if (editModal) {
          editModal.hide();
        }
        
        // 重置表单
        $('#editAssignmentForm')[0].reset();
        
        // 更新列表
        renderAssignedVisitTasks();
        renderPendingExecutionTasks();
      });

      // 提交回访分配表单
      $('#visitAssignmentForm').submit(function(e) {
        e.preventDefault();
        
        if (selectedClients.length === 0) {
          showMessage('错误', '请先选择要分配的服务对象', 'error');
          return;
        }
        
        const visitType = parseInt($('#assignmentVisitType').val());
        const opId = parseInt($('#assignmentOpId').val());
        
        if (!visitType || !opId) {
          showMessage('错误', '请填写完整的分配信息', 'error');
          return;
        }
        
        // 为每个选中的服务对象创建回访记录
        selectedClients.forEach(client => {
          // 模拟API调用：POST /returnvisitRecodes
          const newTask = {
            id: assignedVisitTasks.length + 1, // 模拟新记录的ID
            client_id: client.client_id,
            client_name: client.client_name,
            visit_type: visitType,
            op_id: opId,
            alloc_time: new Date().toISOString().slice(0, 19).replace('T', ' '),
            op_time: null, // 执行时设置
            satisfaction: null,
            client_req: null,
            visit_desc: null
          };
          
          assignedVisitTasks.push(newTask);
        });
        
        console.log('回访分配API调用：POST /returnvisitRecodes', {
          clients: selectedClients.map(c => ({ client_id: c.client_id, visit_type: visitType, op_id: opId }))
        });
        
        showMessage('成功', `已成功分配 ${selectedClients.length} 个回访任务！`, 'success');
        
        // 清空选择
        selectedClients = [];
        updateSelectedClientsList();
        renderPendingVisitList(mockPendingVisitData);
        
        // 重置表单
        $('#visitAssignmentForm')[0].reset();
        
        // 更新已分配任务列表
        renderAssignedVisitTasks();
        renderPendingExecutionTasks();
      });

      // ==================== 3. 回访执行（POST /returnvisitRecodes/:id） ====================
      // 渲染待执行的回访任务列表
      function renderPendingExecutionTasks() {
        const tbody = $('#pendingExecutionTableBody');
        tbody.empty();
        
        const pendingTasks = assignedVisitTasks.filter(task => !task.op_time);
        
        if (pendingTasks.length === 0) {
          tbody.html('<tr><td colspan="5" class="text-center text-muted">暂无待执行的回访任务</td></tr>');
          return;
        }
        
        pendingTasks.forEach(task => {
          const visitTypeText = task.visit_type === 1 ? '线上回访' : '线下回访';
          const opNameMap = {
            1: '服务主管', 2: '张评估员', 3: '王评估员', 4: '李护理', 5: '王护理'
          };
          const opName = opNameMap[task.op_id] || `用户${task.op_id}`;
          
          const row = `
            <tr>
              <td>${task.client_name || '未知'}</td>
              <td>${visitTypeText}</td>
              <td>${opName}</td>
              <td>${task.alloc_time || '-'}</td>
              <td>
                <button class="btn btn-primary btn-sm execute-visit-btn" 
                        data-id="${task.id}"
                        data-client-id="${task.client_id}"
                        data-client-name="${task.client_name}"
                        data-visit-type="${task.visit_type}">
                  执行回访
                </button>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
        
        // 绑定执行按钮事件
        $('.execute-visit-btn').off('click').on('click', function() {
          const taskId = parseInt($(this).data('id'));
          const clientId = parseInt($(this).data('client-id'));
          const clientName = $(this).data('client-name');
          const visitType = parseInt($(this).data('visit-type'));
          
          const task = assignedVisitTasks.find(t => t.id === taskId);
          if (!task) return;
          
          // 填充执行表单
          $('#executionRecordId').val(taskId);
          $('#executionClientId').val(clientId);
          $('#executionClientName').val(clientName);
          $('#executionVisitType').val(visitType);
          $('#executionOpId').val(task.op_id);
          $('#executionVisitTypeName').val(visitType === 1 ? '线上回访' : '线下回访');
          
          // 显示表单
          $('#executionFormCard').show();
          $('html, body').animate({ scrollTop: $('#executionFormCard').offset().top - 20 }, 300);
        });
      }

      // 关闭执行表单
      $('#closeExecutionForm').click(function() {
        $('#executionFormCard').hide();
        $('#visitExecutionForm')[0].reset();
      });

      // 提交回访执行表单
      $('#visitExecutionForm').submit(function(e) {
        e.preventDefault();
        
        const recordId = parseInt($('#executionRecordId').val());
        const satisfaction = parseInt($('input[name="satisfaction"]:checked').val());
        const clientReq = $('#executionClientReq').val();
        const visitDesc = $('#executionVisitDesc').val();
        const clientName = $('#executionClientName').val();
        
        if (!satisfaction) {
          showMessage('错误', '请选择服务对象满意度', 'error');
          return;
        }
        
        // 查找任务并更新
        const task = assignedVisitTasks.find(t => t.id === recordId);
        if (task) {
          // 模拟API调用：POST /returnvisitRecodes/:id
          task.op_time = new Date().toISOString().slice(0, 19).replace('T', ' ');
          task.satisfaction = satisfaction;
          task.client_req = clientReq || null;
          task.visit_desc = visitDesc || null;
          
          // 移动到已执行记录
          executedVisitRecords.push({...task});
          
          console.log('回访执行API调用：POST /returnvisitRecodes/' + recordId, {
            satisfaction: satisfaction,
            visit_desc: visitDesc,
            client_req: clientReq
          });
          
          showMessage('成功', `已成功执行对【${clientName}】的回访！`, 'success');
          
          // 重置表单并隐藏
          $('#visitExecutionForm')[0].reset();
          $('#executionFormCard').hide();
          
          // 更新列表
          renderPendingExecutionTasks();
          renderAssignedVisitTasks();
          loadVisitResultList();
        }
      });
      
      // ==================== 4. 回访结果查询（GET /returnvisitRecodes） ====================
      // 加载回访结果列表
      function loadVisitResultList() {
        const visitType = $('#resultFilterType').val();
        const opId = $('#resultFilterOpId').val();
        const startTime = $('#resultFilterStartTime').val();
        const stopTime = $('#resultFilterStopTime').val();
        
        // 模拟API调用：GET /returnvisitRecodes
        // 参数：startTime, stopTime, op_id, visit_type
        let filteredData = executedVisitRecords.filter(record => record.op_time);
        
        // 按回访类型筛选
        if (visitType) {
          filteredData = filteredData.filter(item => item.visit_type === parseInt(visitType));
        }
        
        // 按执行人筛选
        if (opId) {
          filteredData = filteredData.filter(item => item.op_id === parseInt(opId));
        }
        
        // 按分配时间范围筛选（起止时间需同时选择）
        if (startTime && stopTime) {
          filteredData = filteredData.filter(item => {
            if (!item.alloc_time) return false;
            const allocDate = item.alloc_time.split(' ')[0];
            return allocDate >= startTime && allocDate <= stopTime;
          });
        } else if (startTime || stopTime) {
          showMessage('提示', '起止时间需同时选择', 'info');
        }
        
        renderVisitResultList(filteredData);
      }

      // 渲染回访结果列表
      function renderVisitResultList(data) {
        const tbody = $('#visitResultTableBody');
        tbody.empty();
        
        if (!data || data.length === 0) {
          tbody.html('<tr><td colspan="7" class="text-center text-muted">暂无回访记录</td></tr>');
          return;
        }
        
        data.forEach(item => {
          const visitTypeText = item.visit_type === 1 ? '线上回访' : '线下回访';
          const opNameMap = {
            1: '服务主管', 2: '张评估员', 3: '王评估员', 4: '李护理', 5: '王护理'
          };
          const opName = opNameMap[item.op_id] || `用户${item.op_id}`;
          
          const satisfactionValue = parseInt(item.satisfaction);
          const satisfactionEntry = SATISFACTION_MAP[satisfactionValue];
          const satisfactionText = satisfactionEntry ? satisfactionEntry.text : '-';
          const satisfactionBadge = satisfactionEntry ? satisfactionEntry.badge : '';
          const hasPhoto = item.visit_type === 2; // 线下回访才有照片
          
          const row = `
            <tr>
              <td>${item.client_name || '未知'}</td>
              <td>${visitTypeText}</td>
              <td><span class="status-badge ${satisfactionBadge}">${satisfactionText}</span></td>
              <td>${opName}</td>
              <td>${item.alloc_time || '-'}</td>
              <td>${item.op_time || '-'}</td>
              <td>
                ${hasPhoto ? `<button class="btn btn-outline-secondary btn-sm view-photo-btn" data-id="${item.id}">查看照片</button>` : '-'}
              </td>
            </tr>
          `;
          tbody.append(row);
        });
        
        // 重新绑定查看照片按钮事件
        $('.view-photo-btn').off('click').on('click', handleViewPhoto);
      }
      
      // ==================== 事件绑定 ====================
      // 待回访列表 - 全选/取消全选
      $('#selectAllPending').change(function() {
        const isChecked = $(this).prop('checked');
        $('.pending-checkbox').prop('checked', isChecked).trigger('change');
      });

      // 随机选择按钮
      $('#randomSelectBtn').click(function() {
        randomSelectClients(3);
      });

      // 筛选按钮 - 显示/隐藏筛选面板
      $('#pendingFilterBtn').click(function() {
        const panel = $('#pendingFilterPanel');
        if (panel.is(':visible')) {
          panel.slideUp();
          $(this).removeClass('active');
        } else {
          panel.slideDown();
          $(this).addClass('active');
        }
      });

      // 未回访时间间隔选择变化事件
      $('#filterVisitInterval').change(function() {
        if ($(this).val() === 'custom') {
          $('#customDaysGroup').show();
        } else {
          $('#customDaysGroup').hide();
          $('#filterCustomDays').val('');
        }
      });

      // 应用筛选按钮
      $('#applyPendingFilter').click(function() {
        applyPendingFilter();
      });

      // 重置筛选按钮
      $('#resetPendingFilter').click(function() {
        resetPendingFilter();
      });

      // 查看照片按钮点击事件
      function handleViewPhoto() {
        const visitId = $(this).data('id');
        const clientName = $(this).data('client-name') || '服务对象';
        
        // 更新模态框标题
        $('#photoPreviewTitle').text(`【${clientName}】的现场照片`);
        
        // 使用模拟照片数据
        const mockPhotos = [
          {id: 1, store_filename: 'photo1.jpg'},
          {id: 2, store_filename: 'photo2.jpg'},
          {id: 3, store_filename: 'photo3.jpg'}
        ];
        
        renderPhotoCarousel(mockPhotos, visitId);
        photoPreviewModal.show();
      }

      // 渲染照片轮播
      function renderPhotoCarousel(photoList, visitId) {
        const carouselInner = $('#photoCarousel .carousel-inner');
        carouselInner.empty();
        
        if (!photoList || photoList.length === 0) {
          carouselInner.html('<div class="carousel-item active"><div class="text-center p-5">暂无照片</div></div>');
          return;
        }
        
        photoList.forEach((photo, index) => {
          const isActive = index === 0 ? 'active' : '';
          const photoUrl = `https://via.placeholder.com/800x600?text=现场照片${index + 1}`;
          
          const item = `
            <div class="carousel-item ${isActive}">
              <img src="${photoUrl}" class="d-block w-100" alt="现场照片${index + 1}" style="max-height: 600px; object-fit: contain;">
            </div>
          `;
          carouselInner.append(item);
        });
      }

      // 导出报表按钮点击事件
      $('#exportResultBtn').click(function() {
        const table = document.getElementById('visitResultTable');
        if (!table) {
          return;
        }
        
        try {
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.table_to_sheet(table);
          XLSX.utils.book_append_sheet(workbook, worksheet, '回访结果');
          const fileName = `回访结果报表_${new Date().toISOString().slice(0,10)}.xlsx`;
          XLSX.writeFile(workbook, fileName);
          showMessage('成功', '报表导出成功', 'success');
        } catch (e) {
          console.error('导出失败:', e);
        }
      });
      
      // 回访结果查询按钮
      $('#resultFilterBtn').click(function() {
        loadVisitResultList();
      });
      
      // 标签页切换事件
      $('#visitTabs button').on('shown.bs.tab', function(e) {
        const targetTab = $(e.target).data('bs-target');
        
        if (targetTab === '#pending-visit') {
          loadPendingVisitList();
        } else if (targetTab === '#visit-assignment') {
          renderAssignedVisitTasks();
        } else if (targetTab === '#visit-execution') {
          renderPendingExecutionTasks();
        } else if (targetTab === '#visit-result') {
          loadVisitResultList();
        }
      });
      
      // 服务对象详情功能
      const objectDetailModal = new bootstrap.Modal('#objectDetailModal');
      const mockClientDetailData = {
        101: { id: 101, name: '陈一', gender: '男', level: '一级', address: '杭州市西湖区XX路123号', phone: '13800138001', status: '正常', caregiver: '李护理', remainHours: 1, workOrders: '每周一、三、五，每次2小时' },
        102: { id: 102, name: '吴二', gender: '女', level: '二级', address: '杭州市拱墅区XX路456号', phone: '13800138002', status: '正常', caregiver: '王护理', remainHours: 3, workOrders: '每周二、四、六，每次2.5小时' },
        103: { id: 103, name: '郑三', gender: '男', level: '三级', address: '杭州市西湖区XX路789号', phone: '13800138003', status: '正常', caregiver: '李护理', remainHours: 30, workOrders: '每周一、三、五，每次2小时' },
        104: { id: 104, name: '冯四', gender: '女', level: '一级', address: '杭州市滨江区XX路321号', phone: '13800138004', status: '正常', caregiver: '张护理', remainHours: 60, workOrders: '每周一、三、五，每次2小时' },
        105: { id: 105, name: '钱五', gender: '男', level: '二级', address: '杭州市上城区XX路654号', phone: '13800138005', status: '正常', caregiver: '王护理', remainHours: 28.5, workOrders: '每周二、四、六，每次2.5小时' },
        106: { id: 106, name: '赵六', gender: '女', level: '三级', address: '杭州市下城区XX路987号', phone: '13800138006', status: '正常', caregiver: '李护理', remainHours: 42.2, workOrders: '每周一、三、五，每次2小时' },
        107: { id: 107, name: '孙七', gender: '男', level: '一级', address: '杭州市江干区XX路111号', phone: '13800138007', status: '正常', caregiver: '王护理', remainHours: 15, workOrders: '每周二、四、六，每次2小时' }
      };
      
      function showObjectDetail(objId) {
        const obj = mockClientDetailData[objId];
        if (!obj) {
          alert('未找到服务对象数据');
          return;
        }
        
        const basicInfoHtml = `
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">姓名</label>
                <div class="form-control-plaintext">${obj.name}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">性别</label>
                <div class="form-control-plaintext">${obj.gender}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">失能等级</label>
                <div class="form-control-plaintext">${obj.level}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">居住地址</label>
                <div class="form-control-plaintext">${obj.address}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">联系电话</label>
                <div class="form-control-plaintext">${obj.phone || '-'}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">服务状态</label>
                <div class="form-control-plaintext">${obj.status}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">负责护理员</label>
                <div class="form-control-plaintext">${obj.caregiver}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">剩余工时</label>
                <div class="form-control-plaintext">${obj.remainHours}小时</div>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">工单安排</label>
                <div class="form-control-plaintext">${obj.workOrders || '-'}</div>
              </div>
            </div>
          </div>
        `;
        
        $('#objectDetailModalTitle').text(`服务对象详情 - ${obj.name}`);
        $('#objectDetailBody').html(basicInfoHtml);
        objectDetailModal.show();
      }
      
      $(document).on('click', '.obj-detail-link', function(e) {
        e.stopPropagation();
        const objId = parseInt($(this).data('id'));
        showObjectDetail(objId);
      });
      
      // 页面加载时初始化数据
      loadPendingVisitList();
      renderAssignedVisitTasks();
      renderPendingExecutionTasks();
    });
  </script>
  
  <!-- 修改回访分配模态框 -->
  <div class="modal fade" id="editAssignmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">修改回访分配</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editAssignmentForm">
            <input type="hidden" id="editAssignmentRecordId" name="id">
            <input type="hidden" id="editAssignmentClientId" name="client_id">
            
            <div class="mb-3">
              <label for="editAssignmentClientName" class="form-label">服务对象 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editAssignmentClientName" readonly>
              <small class="form-text text-muted">服务对象不可修改</small>
            </div>
            
            <div class="mb-3">
              <label for="editAssignmentVisitType" class="form-label">回访类型 <span class="text-danger">*</span></label>
              <select class="form-select" id="editAssignmentVisitType" name="visit_type" required>
                <option value="">请选择回访类型</option>
                <option value="1">线上回访</option>
                <option value="2">线下回访</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="editAssignmentOpId" class="form-label">分配执行回访的用户 <span class="text-danger">*</span></label>
              <select class="form-select" id="editAssignmentOpId" name="op_id" required>
                <option value="">请选择执行人</option>
                <option value="1">服务主管</option>
                <option value="2">张评估员</option>
                <option value="3">王评估员</option>
                <option value="4">李护理</option>
                <option value="5">王护理</option>
              </select>
            </div>
            
            <div class="alert alert-info">
              <i class="fa fa-info-circle"></i> 
              <strong>API说明：</strong> PUT /returnvisitRecodes/:id<br>
              参数：client_id（服务对象标识）、visit_type（回访类型）、op_id（分配执行回访的用户标识）<br>
              返回：成功时返回空对象
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary" form="editAssignmentForm">
            <i class="fa fa-save"></i> 保存修改
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 服务对象详情模态框 -->
  <div class="modal fade" id="objectDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="objectDetailModalTitle">服务对象详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="objectDetailBody" class="mt-3">
            <!-- 基本信息内容将通过JavaScript动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
