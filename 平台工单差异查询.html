<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>平台与医保工单差异查询 - 工单管理</title>
  <!-- 引入外部资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <style>
    /* 继承全局样式 */
    body { font-family: "微软雅黑", "思源黑体", sans-serif; background-color: #f5f7fa; color: #333; }
    .btn-primary { background-color: #1890FF; border-color: #1890FF; }
    .btn-primary:hover { background-color: #096DD9; border-color: #096DD9; }
    .btn-outline-secondary { border-color: #ddd; color: #666; }
    .btn-outline-secondary:hover { background-color: #f5f5f5; border-color: #ccc; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0; padding: 15px 20px; font-weight: 600; font-size: 15px; }
    .card-body { padding: 20px; }
    /* 布局样式 */
    .app-container { display: flex; min-height: 100vh; }
    /* 侧边导航 */
    .sidebar { width: 220px; background: #fff; box-shadow: 1px 0 2px rgba(0,0,0,0.05); padding: 20px 0; flex-shrink: 0; }
    .sidebar-logo { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
    .sidebar-logo img { height: 40px; margin-bottom: 8px; }
    .sidebar-logo h3 { font-size: 16px; color: #1890FF; font-weight: 600; margin: 0; }
    .nav-menu { list-style: none; padding: 0; margin: 0; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #666; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
    .nav-link:hover, .nav-link.active { color: #1890FF; background-color: #f0f7ff; border-left: 3px solid #1890FF; }
    .nav-link i { font-size: 18px; margin-right: 12px; width: 20px; text-align: center; }
    .nav-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 500; }
    /* 主内容区 */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    /* 顶部导航 */
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0; }
    .user-info { display: flex; align-items: center; }
    .notification { position: relative; margin-right: 20px; cursor: pointer; }
    .notification i { font-size: 20px; color: #666; }
    .notification-badge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #FF4D4F; color: #fff; border-radius: 50%; font-size: 12px; text-align: center; line-height: 18px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1890FF; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; margin-right: 10px; }
    .user-name { font-size: 14px; font-weight: 500; }

    /* 平台工单差异查询页面专属样式 */
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .toolbar-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .toolbar-right { display: flex; gap: 10px; }
    .month-selector { display: flex; align-items: center; gap: 10px; }
    .month-selector label { font-weight: 500; white-space: nowrap; }
    .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
    .filter-tab { padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .filter-tab:hover { color: #1890FF; }
    .filter-tab.active { color: #1890FF; border-bottom-color: #1890FF; font-weight: 600; }
    .difference-table { width: 100%; border-collapse: collapse; }
    .difference-table th, .difference-table td { border: 1px solid #f0f0f0; padding: 12px 15px; text-align: left; font-size: 13px; }
    .difference-table th { background-color: #f8f9fa; font-weight: 500; }
    .difference-table tbody tr { background-color: #fff; }
    .difference-table tbody tr:hover { background-color: #f9f9f9; }
    /* 差异类型标签 */
    .diff-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-no-match { background-color: #fff1f0; color: #FF4D4F; border: 1px solid #FF4D4F; }
    .badge-consistent { background-color: #e6f7ef; color: #52C41A; border: 1px solid #52C41A; }
    .badge-time-diff { background-color: #fffbe6; color: #FAAD14; border: 1px solid #FAAD14; }
    .badge-processed { background-color: #f0f0f0; color: #666; border: 1px solid #d9d9d9; }
    /* 详情弹窗样式 */
    .detail-modal .modal-dialog { max-width: 1000px; }
    .detail-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .detail-panel { border: 1px solid #f0f0f0; border-radius: 8px; padding: 15px; }
    .detail-panel h6 { font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
    .detail-item { margin-bottom: 12px; }
    .detail-label { font-weight: 500; color: #666; margin-bottom: 5px; font-size: 13px; }
    .detail-value { color: #333; font-size: 14px; }
    .detail-screenshot { margin-top: 10px; }
    .detail-screenshot img { max-width: 100%; border: 1px solid #f0f0f0; border-radius: 4px; }
    .guidance-box { background-color: #f0f7ff; border-left: 4px solid #1890FF; padding: 15px; border-radius: 4px; margin-top: 20px; }
    .guidance-box h6 { color: #1890FF; margin-bottom: 10px; }
    .guidance-box p { margin: 0; color: #666; font-size: 13px; line-height: 1.6; }
    .file-upload-area { border: 2px dashed #d9d9d9; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .file-upload-area:hover { border-color: #1890FF; background-color: #f0f7ff; }
    .file-upload-area.dragover { border-color: #1890FF; background-color: #e6f7ff; }
    .file-upload-icon { font-size: 48px; color: #1890FF; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 侧边导航 -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <img src="https://via.placeholder.com/80x40?text=居家长护" alt="系统Logo">
        <h3>服务主管工作平台</h3>
      </div>
      
      <!-- 导航分组：看板管理 -->
      <div class="nav-group-title">看板管理</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="index.html" class="nav-link">
            <i class="fa fa-dashboard"></i>
            <span>服务对象看板</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="总体统计.html" class="nav-link">
            <i class="fa fa-bar-chart"></i>
            <span>总体统计看板</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="流程管理.html" class="nav-link">
            <i class="fa fa-sitemap"></i>
            <span>流程管理</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="线上回访.html" class="nav-link">
            <i class="fa fa-phone"></i>
            <span>线上线下回访执行</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="服务对象分配.html" class="nav-link">
            <i class="fa fa-users"></i>
            <span>服务对象分配</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="新增服务对象管理.html" class="nav-link">
            <i class="fa fa-user-plus"></i>
            <span>新增服务对象配置</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="首月服务计划管理.html" class="nav-link">
            <i class="fa fa-calendar"></i>
            <span>服务计划管理或打印</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="平台工单差异查询.html" class="nav-link active">
            <i class="fa fa-search"></i>
            <span>医保工单差异查询</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="工单管理.html" class="nav-link">
            <i class="fa fa-tasks"></i>
            <span>工单管理</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="重点服务对象管理.html" class="nav-link">
            <i class="fa fa-star"></i>
            <span>重点服务对象管理</span>
          </a>
        </li>
      </ul>
      
      <!-- 导航分组：系统设置 -->
      <div class="nav-group-title">系统设置</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link" id="caregiverSettingsLink">
            <i class="fa fa-cog"></i>
            <span>护理员设置</span>
          </a>
        </li>
      </ul>
    </div>


    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 顶部导航：标题 + 用户信息 -->
      <div class="top-nav">
        <h1 class="page-title">平台与医保工单差异查询</h1>
        <div class="user-info">
          <div class="notification">
            <i class="fa fa-bell-o"></i>
            <span class="notification-badge">2</span>
          </div>
          <div class="user-avatar">主</div>
          <div class="user-name">服务主管</div>
        </div>
      </div>

      <!-- 工具栏 -->
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="month-selector">
            <label for="serviceMonth">服务月份：</label>
            <input type="month" class="form-control" id="serviceMonth" value="2024-09" style="width: 150px;">
          </div>
          <button class="btn btn-primary" id="importInsuranceBtn">
            <i class="fa fa-upload"></i> 导入医保工单
          </button>
          <button class="btn btn-outline-secondary" id="recompareBtn">
            <i class="fa fa-refresh"></i> 重新比对
          </button>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-outline-secondary" id="exportReportBtn">
            <i class="fa fa-download"></i> 导出差异报表
          </button>
        </div>
      </div>

      <!-- 差异类型筛选栏 -->
      <div class="filter-tabs">
        <button class="filter-tab active" data-type="all">全部</button>
        <button class="filter-tab" data-type="no-match">无匹配记录</button>
        <button class="filter-tab" data-type="consistent">一致</button>
        <button class="filter-tab" data-type="time-diff">时间差异过大</button>
        <button class="filter-tab" data-type="processed">已处理</button>
      </div>

      <!-- 差异列表 -->
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span>差异列表</span>
            <span class="text-muted" style="font-size: 13px; font-weight: normal;">
              共 <span id="totalCount">0</span> 条差异，未处理 <span id="unprocessedCount">0</span> 条
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="difference-table" id="differenceTable">
              <thead>
                <tr>
                  <th style="width: 60px;">序号</th>
                  <th style="width: 100px;">服务对象</th>
                  <th style="width: 150px;">身份证号</th>
                  <th style="width: 120px;">服务日期</th>
                  <th style="width: 120px;">差异类型</th>
                  <th style="width: 200px;">机构数据</th>
                  <th style="width: 200px;">医保数据</th>
                  <th style="width: 100px;">操作</th>
                </tr>
              </thead>
              <tbody id="differenceTableBody">
                <!-- 数据将通过JS动态生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 导入医保工单模态框 -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">导入医保工单</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="file-upload-area" id="fileUploadArea">
            <div class="file-upload-icon">
              <i class="fa fa-cloud-upload"></i>
            </div>
            <p style="margin: 10px 0; color: #666;">点击或拖拽文件到此处上传</p>
            <p style="font-size: 12px; color: #999;">支持 Excel 格式（.xlsx, .xls）</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
          </div>
          <div id="fileInfo" style="margin-top: 15px; display: none;">
            <div class="alert alert-info">
              <i class="fa fa-file-excel-o"></i> 
              <span id="fileName"></span>
              <button type="button" class="btn btn-sm btn-outline-secondary float-end" id="removeFileBtn">移除</button>
            </div>
          </div>
          <div class="alert alert-warning mt-3">
            <i class="fa fa-info-circle"></i> 
            <strong>提示：</strong>请确保Excel文件包含以下字段：服务对象姓名、身份证号、服务日期、开始时间、结束时间、护理员工号
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="confirmImportBtn" disabled>确认导入</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 差异详情弹窗 -->
  <div class="modal fade detail-modal" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalTitle">差异详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="detail-comparison" id="detailComparison">
            <!-- 左右分栏对比内容 -->
          </div>
          
          <div class="guidance-box" id="guidanceBox">
            <!-- 处理指引 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" class="btn btn-success" id="markProcessedBtn">
            <i class="fa fa-check"></i> 标记为已处理
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(function() {
      // 统一的提示函数
      function showMessage(title, message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        const alertHtml = `
          <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <strong>${title}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        $('body').append(alertHtml);
        setTimeout(() => {
          $('.alert').fadeOut(() => $(this).remove());
        }, 3000);
      }
      
      // 初始化模态框
      const importModal = new bootstrap.Modal('#importModal');
      const detailModal = new bootstrap.Modal('#detailModal');
      
      // 模拟差异数据（只有三种类型：无匹配记录、一致、时间差异过大）
      const mockDifferenceData = [
        {
          id: 1,
          clientId: 1,
          clientName: '陈一',
          idCard: '330106********1234',
          serviceDate: '2024-09-15',
          diffType: 'time-diff',
          orgData: { duration: 120, caregiver: '李护理', startTime: '09:00', endTime: '11:00', items: '整理床单位、协助进食' },
          insuranceData: { duration: 120, caregiver: '李护理', startTime: '09:30', endTime: '11:30', items: '整理床单位、协助进食' },
          processed: false
        },
        {
          id: 2,
          clientId: 2,
          clientName: '吴二',
          idCard: '330105********5678',
          serviceDate: '2024-09-16',
          diffType: 'no-match',
          orgData: null,
          insuranceData: { duration: 60, caregiver: '王护理', startTime: '14:00', endTime: '15:00', items: '口腔清洁' },
          processed: false
        },
        {
          id: 3,
          clientId: 3,
          clientName: '郑三',
          idCard: '330602********9012',
          serviceDate: '2024-09-17',
          diffType: 'no-match',
          orgData: { duration: 45, caregiver: '张护理', startTime: '10:00', endTime: '10:45', items: '协助洗漱' },
          insuranceData: null,
          processed: false
        },
        {
          id: 4,
          clientId: 4,
          clientName: '冯四',
          idCard: '330602********3456',
          serviceDate: '2024-09-18',
          diffType: 'consistent',
          orgData: { duration: 90, caregiver: '李护理', startTime: '08:00', endTime: '09:30', items: '协助进食、肢体功能训练' },
          insuranceData: { duration: 90, caregiver: '李护理', startTime: '08:00', endTime: '09:30', items: '协助进食、肢体功能训练' },
          processed: false
        },
        {
          id: 5,
          clientId: 5,
          clientName: '钱五',
          idCard: '330602********7890',
          serviceDate: '2024-09-19',
          diffType: 'consistent',
          orgData: { duration: 60, caregiver: '王护理', startTime: '15:00', endTime: '16:00', items: '压疮护理' },
          insuranceData: { duration: 60, caregiver: '王护理', startTime: '15:00', endTime: '16:00', items: '压疮护理' },
          processed: true
        }
      ];

      let currentFilterType = 'all';
      let currentDetailId = null;

      // 渲染差异列表
      function renderDifferenceList() {
        const tbody = $('#differenceTableBody');
        tbody.empty();
        
        let filteredData = mockDifferenceData;
        
        // 按类型筛选
        if (currentFilterType !== 'all') {
          if (currentFilterType === 'processed') {
            filteredData = mockDifferenceData.filter(item => item.processed);
          } else {
            filteredData = mockDifferenceData.filter(item => item.diffType === currentFilterType && !item.processed);
          }
        } else {
          filteredData = mockDifferenceData.filter(item => !item.processed);
        }
        
        if (filteredData.length === 0) {
          tbody.html('<tr><td colspan="8" class="text-center text-muted">暂无差异记录</td></tr>');
          $('#totalCount').text(0);
          $('#unprocessedCount').text(0);
          return;
        }
        
        filteredData.forEach((item, index) => {
          const badgeClass = item.processed ? 'badge-processed' :
                            item.diffType === 'no-match' ? 'badge-no-match' :
                            item.diffType === 'consistent' ? 'badge-consistent' :
                            'badge-time-diff';
          
          const diffTypeText = item.processed ? '已处理' :
                              item.diffType === 'no-match' ? '无匹配记录' :
                              item.diffType === 'consistent' ? '一致' :
                              '时间差异过大';
          
          let orgDataText = '-';
          let insuranceDataText = '-';
          
          if (item.diffType === 'no-match') {
            if (item.orgData) {
              orgDataText = `${item.orgData.duration}分钟 (${item.orgData.caregiver})`;
            }
            if (item.insuranceData) {
              insuranceDataText = `${item.insuranceData.duration}分钟 (${item.insuranceData.caregiver})`;
            }
          } else if (item.diffType === 'consistent') {
            orgDataText = `${item.orgData.duration}分钟 (${item.orgData.caregiver})`;
            insuranceDataText = `${item.insuranceData.duration}分钟 (${item.insuranceData.caregiver})`;
          } else if (item.diffType === 'time-diff') {
            orgDataText = `${item.orgData.duration}分钟 (${item.orgData.startTime}-${item.orgData.endTime})`;
            insuranceDataText = `${item.insuranceData.duration}分钟 (${item.insuranceData.startTime}-${item.insuranceData.endTime})`;
          }
          
          const detailLink = item.clientId ? `<a href="javascript:void(0)" class="obj-detail-link" data-id="${item.clientId}" title="查看详情" style="color: #1890FF; margin-left: 8px;"><i class="fa fa-info-circle"></i></a>` : '';
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>
                ${item.clientName}
                ${detailLink}
              </td>
              <td>${item.idCard}</td>
              <td>${item.serviceDate}</td>
              <td><span class="diff-badge ${badgeClass}">${diffTypeText}</span></td>
              <td>${orgDataText}</td>
              <td>${insuranceDataText}</td>
              <td>
                <button class="btn btn-primary btn-sm view-detail-btn" data-id="${item.id}">
                  <i class="fa fa-eye"></i> 查看详情
                </button>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
        
        // 更新统计
        $('#totalCount').text(mockDifferenceData.length);
        $('#unprocessedCount').text(mockDifferenceData.filter(item => !item.processed).length);
        
        // 重新绑定查看详情按钮事件
        $('.view-detail-btn').off('click').on('click', function() {
          const id = parseInt($(this).data('id'));
          showDetailModal(id);
        });
      }

      // 显示详情弹窗
      function showDetailModal(id) {
        currentDetailId = id;
        const item = mockDifferenceData.find(d => d.id === id);
        if (!item) return;
        
        $('#detailModalTitle').text(`差异详情 - ${item.clientName}`);
        
        // 生成对比内容
        let comparisonHtml = '';
        
        if (item.diffType === 'no-match') {
          // 无匹配记录
          if (item.orgData && !item.insuranceData) {
            // 机构有，医保无
            comparisonHtml = `
              <div class="detail-panel">
                <h6>机构工单详情</h6>
                <div class="detail-item">
                  <div class="detail-label">服务时长</div>
                  <div class="detail-value">${item.orgData.duration} 分钟</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">护理员</div>
                  <div class="detail-value">${item.orgData.caregiver}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">服务时间</div>
                  <div class="detail-value">${item.orgData.startTime} - ${item.orgData.endTime}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">服务项目</div>
                  <div class="detail-value">${item.orgData.items}</div>
                </div>
              </div>
              <div class="detail-panel">
                <h6>医保工单详情</h6>
                <div class="text-muted text-center" style="padding: 40px;">
                  <i class="fa fa-exclamation-circle" style="font-size: 48px; color: #ddd;"></i>
                  <p style="margin-top: 15px;">医保平台无此工单记录</p>
                </div>
              </div>
            `;
          } else if (!item.orgData && item.insuranceData) {
            // 医保有，机构无
            comparisonHtml = `
              <div class="detail-panel">
                <h6>机构工单详情</h6>
                <div class="text-muted text-center" style="padding: 40px;">
                  <i class="fa fa-exclamation-circle" style="font-size: 48px; color: #ddd;"></i>
                  <p style="margin-top: 15px;">机构平台无此工单记录</p>
                </div>
              </div>
              <div class="detail-panel">
                <h6>医保工单详情</h6>
                <div class="detail-item">
                  <div class="detail-label">服务时长</div>
                  <div class="detail-value">${item.insuranceData.duration} 分钟</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">护理员</div>
                  <div class="detail-value">${item.insuranceData.caregiver}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">服务时间</div>
                  <div class="detail-value">${item.insuranceData.startTime} - ${item.insuranceData.endTime}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">服务项目</div>
                  <div class="detail-value">${item.insuranceData.items}</div>
                </div>
              </div>
            `;
          }
        } else if (item.diffType === 'consistent') {
          // 一致
          comparisonHtml = `
            <div class="detail-panel">
              <h6>机构工单详情</h6>
              <div class="detail-item">
                <div class="detail-label">服务时长</div>
                <div class="detail-value">${item.orgData.duration} 分钟</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">护理员</div>
                <div class="detail-value">${item.orgData.caregiver}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务时间</div>
                <div class="detail-value">${item.orgData.startTime} - ${item.orgData.endTime}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务项目</div>
                <div class="detail-value">${item.orgData.items}</div>
              </div>
            </div>
            <div class="detail-panel">
              <h6>医保工单详情</h6>
              <div class="detail-item">
                <div class="detail-label">服务时长</div>
                <div class="detail-value">${item.insuranceData.duration} 分钟</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">护理员</div>
                <div class="detail-value">${item.insuranceData.caregiver}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务时间</div>
                <div class="detail-value">${item.insuranceData.startTime} - ${item.insuranceData.endTime}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务项目</div>
                <div class="detail-value">${item.insuranceData.items}</div>
              </div>
            </div>
          `;
        } else if (item.diffType === 'time-diff') {
          // 时间差异过大
          comparisonHtml = `
            <div class="detail-panel">
              <h6>机构工单详情</h6>
              <div class="detail-item">
                <div class="detail-label">服务时长</div>
                <div class="detail-value">${item.orgData.duration} 分钟</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">护理员</div>
                <div class="detail-value">${item.orgData.caregiver}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务时间</div>
                <div class="detail-value">${item.orgData.startTime} - ${item.orgData.endTime}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务项目</div>
                <div class="detail-value">${item.orgData.items}</div>
              </div>
            </div>
            <div class="detail-panel">
              <h6>医保工单详情</h6>
              <div class="detail-item">
                <div class="detail-label">服务时长</div>
                <div class="detail-value">${item.insuranceData.duration} 分钟</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">护理员</div>
                <div class="detail-value">${item.insuranceData.caregiver}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务时间</div>
                <div class="detail-value">${item.insuranceData.startTime} - ${item.insuranceData.endTime}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">服务项目</div>
                <div class="detail-value">${item.insuranceData.items}</div>
              </div>
            </div>
          `;
        }
        
        $('#detailComparison').html(comparisonHtml);
        
        // 生成处理指引
        let guidanceHtml = '';
        if (item.diffType === 'no-match') {
          if (item.orgData && !item.insuranceData) {
            guidanceHtml = `
              <h6><i class="fa fa-lightbulb-o"></i> 处理指引</h6>
              <p><strong>无匹配记录：</strong>机构平台有此工单，但医保平台无对应记录。</p>
              <p>建议联系医保接口人补报该工单，或确认是否需要在医保平台重新申报。</p>
            `;
          } else if (!item.orgData && item.insuranceData) {
            guidanceHtml = `
              <h6><i class="fa fa-lightbulb-o"></i> 处理指引</h6>
              <p><strong>无匹配记录：</strong>医保平台有此工单，但机构平台无对应记录。</p>
              <p>建议联系护理员补充录入机构工单，或核实该工单是否确实执行。</p>
            `;
          }
        } else if (item.diffType === 'consistent') {
          guidanceHtml = `
            <h6><i class="fa fa-lightbulb-o"></i> 处理指引</h6>
            <p><strong>一致：</strong>机构平台和医保平台的工单数据完全一致，无需处理。</p>
          `;
        } else if (item.diffType === 'time-diff') {
          const orgStart = item.orgData.startTime.split(':');
          const insStart = item.insuranceData.startTime.split(':');
          const orgStartMinutes = parseInt(orgStart[0]) * 60 + parseInt(orgStart[1]);
          const insStartMinutes = parseInt(insStart[0]) * 60 + parseInt(insStart[1]);
          const timeDiff = Math.abs(orgStartMinutes - insStartMinutes);
          guidanceHtml = `
            <h6><i class="fa fa-lightbulb-o"></i> 处理指引</h6>
            <p><strong>时间差异过大：</strong>机构记录服务时间为 ${item.orgData.startTime}-${item.orgData.endTime}，医保记录为 ${item.insuranceData.startTime}-${item.insuranceData.endTime}，时间差异 ${timeDiff} 分钟。</p>
            <p>建议联系医保接口人核实医保平台时间记录，或检查机构平台工单时间录入是否有误。</p>
          `;
        }
        
        $('#guidanceBox').html(guidanceHtml);
        
        // 显示/隐藏标记按钮
        if (item.processed) {
          $('#markProcessedBtn').hide();
        } else {
          $('#markProcessedBtn').show();
        }
        
        detailModal.show();
      }

      // 差异类型筛选
      $('.filter-tab').click(function() {
        $('.filter-tab').removeClass('active');
        $(this).addClass('active');
        currentFilterType = $(this).data('type');
        renderDifferenceList();
      });

      // 导入医保工单按钮
      $('#importInsuranceBtn').click(function() {
        importModal.show();
      });

      // 文件上传区域点击
      $('#fileUploadArea').click(function() {
        $('#fileInput').click();
      });

      // 文件选择
      $('#fileInput').change(function(e) {
        const file = e.target.files[0];
        if (file) {
          $('#fileName').text(file.name);
          $('#fileInfo').show();
          $('#confirmImportBtn').prop('disabled', false);
        }
      });

      // 移除文件
      $('#removeFileBtn').click(function(e) {
        e.stopPropagation();
        $('#fileInput').val('');
        $('#fileInfo').hide();
        $('#confirmImportBtn').prop('disabled', true);
      });

      // 拖拽上传
      $('#fileUploadArea').on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
      });

      $('#fileUploadArea').on('dragleave', function() {
        $(this).removeClass('dragover');
      });

      $('#fileUploadArea').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        const file = e.originalEvent.dataTransfer.files[0];
        if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
          $('#fileInput')[0].files = e.originalEvent.dataTransfer.files;
          $('#fileName').text(file.name);
          $('#fileInfo').show();
          $('#confirmImportBtn').prop('disabled', false);
        } else {
          showMessage('提示', '请上传Excel格式文件（.xlsx 或 .xls）', 'warning');
        }
      });

      // 确认导入
      $('#confirmImportBtn').click(function() {
        const file = $('#fileInput')[0].files[0];
        if (!file) return;
        
        // 模拟导入处理
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // 这里可以使用 XLSX 库解析文件
            // const workbook = XLSX.read(e.target.result, {type: 'binary'});
            // 解析后与机构工单比对
            
            showMessage('成功', '医保工单导入成功！系统正在比对差异...', 'success');
            importModal.hide();
            
            // 重新渲染列表（模拟比对后的数据）
            setTimeout(() => {
              renderDifferenceList();
            }, 500);
          } catch (error) {
            showMessage('错误', '文件解析失败，请检查文件格式是否正确', 'error');
          }
        };
        reader.readAsBinaryString(file);
      });

      // 重新比对
      $('#recompareBtn').click(function() {
        if (confirm('确定要重新比对吗？这将重新分析所有工单差异。')) {
          showMessage('提示', '正在重新比对...', 'info');
          setTimeout(() => {
            renderDifferenceList();
            showMessage('成功', '比对完成！', 'success');
          }, 1000);
        }
      });

      // 标记为已处理
      $('#markProcessedBtn').click(function() {
        if (!currentDetailId) return;
        
        const item = mockDifferenceData.find(d => d.id === currentDetailId);
        if (item) {
          item.processed = true;
          showMessage('成功', '已标记为已处理', 'success');
          detailModal.hide();
          renderDifferenceList();
        }
      });

      // 导出差异报表
      $('#exportReportBtn').click(function() {
        try {
          const table = document.getElementById('differenceTable');
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.table_to_sheet(table);
          XLSX.utils.book_append_sheet(workbook, worksheet, '工单差异报表');
          
          const fileName = `工单差异报表_${$('#serviceMonth').val() || new Date().toISOString().slice(0,7)}.xlsx`;
          XLSX.writeFile(workbook, fileName);
          showMessage('成功', '报表导出成功！', 'success');
        } catch (e) {
          console.error('导出失败:', e);
          showMessage('错误', '报表导出失败，请重试', 'error');
        }
      });

      // 服务对象详情功能
      const objectDetailModal = new bootstrap.Modal('#objectDetailModal');
      const mockClientDetailData = {
        1: { id: 1, name: '陈一', gender: '男', level: '一级', address: '越城区九十村58号', phone: '13800138001', status: '正常', caregiver: '李护理', remainHours: 1, workOrders: '每周一、三、五，每次2小时' },
        2: { id: 2, name: '吴二', gender: '女', level: '二级', address: '柯桥区四五村18号', phone: '13800138002', status: '正常', caregiver: '王护理', remainHours: 3, workOrders: '每周二、四、六，每次2.5小时' },
        3: { id: 3, name: '郑三', gender: '男', level: '三级', address: '上虞区三六村25号', phone: '13800138003', status: '暂停', caregiver: '张护理', remainHours: 30, workOrders: '已暂停' },
        4: { id: 4, name: '冯四', gender: '女', level: '一级', address: '诸暨市一二村88号', phone: '13800138004', status: '正常', caregiver: '李护理', remainHours: 60, workOrders: '每周一、三、五，每次2小时' },
        5: { id: 5, name: '钱五', gender: '男', level: '二级', address: '嵊州市七八村66号', phone: '13800138005', status: '正常', caregiver: '王护理', remainHours: 28.5, workOrders: '每周二、四、六，每次2.5小时' }
      };
      
      function showObjectDetail(objId) {
        const obj = mockClientDetailData[objId];
        if (!obj) {
          alert('未找到服务对象数据');
          return;
        }
        
        const basicInfoHtml = `
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">姓名</label>
                <div class="form-control-plaintext">${obj.name}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">性别</label>
                <div class="form-control-plaintext">${obj.gender}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">失能等级</label>
                <div class="form-control-plaintext">${obj.level}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">居住地址</label>
                <div class="form-control-plaintext">${obj.address}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">联系电话</label>
                <div class="form-control-plaintext">${obj.phone || '-'}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">服务状态</label>
                <div class="form-control-plaintext">${obj.status}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">负责护理员</label>
                <div class="form-control-plaintext">${obj.caregiver}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">剩余工时</label>
                <div class="form-control-plaintext">${obj.remainHours}小时</div>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-group mb-3">
                <label class="form-label fw-bold">工单安排</label>
                <div class="form-control-plaintext">${obj.workOrders || '-'}</div>
              </div>
            </div>
          </div>
        `;
        
        $('#objectDetailModalTitle').text(`服务对象详情 - ${obj.name}`);
        $('#objectDetailBody').html(basicInfoHtml);
        objectDetailModal.show();
      }
      
      $(document).on('click', '.obj-detail-link', function(e) {
        e.stopPropagation();
        const objId = parseInt($(this).data('id'));
        showObjectDetail(objId);
      });

      // 初始化渲染
      renderDifferenceList();
    });
  </script>
  
  <!-- 服务对象详情模态框 -->
  <div class="modal fade" id="objectDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="objectDetailModalTitle">服务对象详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="objectDetailBody" class="mt-3">
            <!-- 基本信息内容将通过JavaScript动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
